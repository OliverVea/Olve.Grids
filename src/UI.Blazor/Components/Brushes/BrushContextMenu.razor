@using Olve.Grids.Grids
@using Olve.Grids.Primitives
@inject ListBrushesOperation ListBrushesOperation
@inject LoggingService LoggingService
@inject ModalService ModalService
@inject ContextMenuService ContextMenuService
@inject SetBrushForTileCornerOperation SetBrushForTileCornerOperation
@inject CreateNewBrushOperation CreateNewBrushOperation


@{
    var firstText = $"Select brush for tile {TileIndex.Index}";
}

<ContextMenuText Text="@firstText"/>
<ContextMenuBrushColor ProjectBrushOrAny="@ProjectBrushOrAny"/>

<ContextMenuDivider/>

@foreach (var brush in _brushes)
{
    <ContextMenuOption OnClick="@(() => HandleSelectBrush(brush.Id))">
        <div class="@TW(Flex, FlexRow, ItemsCenter, Gap(2))">
            <ColorDot Color="@brush.Color"/>

            <span class="@TW(FlexGrow)">
                        @brush.DisplayName
                    </span>

            <Icon IconDescriptor="IconDescriptor.Edit"
                  OnClick="@(e => HandleEditBrush(e, brush))"
                  StopPropagation="@true"/>
        </div>
    </ContextMenuOption>
}

<ContextMenuOption OnClick="@(() => HandleSelectBrush(BrushIdOrAny.Any))">
    <div class="@TW(Flex, FlexRow, ItemsCenter, Gap(2))">
        <ColorDot Color="@ColorString.Transparent"/>

        <span class="@TW(FlexGrow)">
            No brush
        </span>
    </div>
</ContextMenuOption>

<ContextMenuDivider/>

<ContextMenuOption OnClick="HandleNewBrush">
    Add new brush
</ContextMenuOption>

@code {
    [Parameter] [EditorRequired] public TileIndex TileIndex { get; set; }
    [Parameter] [EditorRequired] public ProjectBrushOrAny ProjectBrushOrAny { get; set; } = ProjectBrushOrAny.Any;
    [Parameter] [EditorRequired] public Corner Corner { get; set; }

    private IReadOnlyList<ProjectBrush> _brushes = [ ];

    protected override async Task OnParametersSetAsync()
    {
        var request = new ListBrushesOperation.Request();
        var listBrushesResult = await ListBrushesOperation.ExecuteAsync(request);
        if (listBrushesResult.TryPickProblems(out var problems, out var brushes))
        {
            LoggingService.Show(problems);
            return;
        }

        _brushes = brushes.Brushes.ToArray();
    }

    private async Task HandleEditBrush(MouseEventArgs mouseEventArgs, ProjectBrush brush)
    {
        await ContextMenuService.HideAsync();
        await ModalService.ShowAsync(
            @<EditBrush Brush="@brush"/>,
            "Edit Brush");
    }


    private async Task HandleSelectBrush(BrushIdOrAny brushId)
    {
        SetBrushForTileCornerOperation.Request request = new(TileIndex, Corner, brushId);
        var result = await SetBrushForTileCornerOperation.ExecuteAsync(request);
        if (result.TryPickProblems(out var problems))
        {
            LoggingService.Show(problems);
        }
    }

    private async Task HandleNewBrush()
    {
        CreateNewBrushOperation.Request request = new();
        var result = await CreateNewBrushOperation.ExecuteAsync(request);
        if (result.TryPickProblems(out var problems))
        {
            LoggingService.Show(problems);
        }
    }

}